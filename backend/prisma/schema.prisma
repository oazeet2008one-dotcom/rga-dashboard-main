generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

/// Tenant - องค์กร/ลูกค้า (Multi-tenant Root)
model Tenant {
  id                           String                         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                         String                         @map("name") @db.VarChar(255)
  slug                         String?                        @unique @map("slug") @db.VarChar(100)
  domain                       String?                        @map("domain") @db.VarChar(255)
  logoUrl                      String?                        @map("logo_url")
  primaryColor                 String?                        @default("#3B82F6") @map("primary_color") @db.VarChar(7)
  secondaryColor               String?                        @default("#10B981") @map("secondary_color") @db.VarChar(7)
  timezone                     String?                        @default("Asia/Bangkok") @map("timezone") @db.VarChar(50)
  currency                     String?                        @default("THB") @map("currency") @db.VarChar(3)
  language                     String?                        @default("th") @map("language") @db.VarChar(5)
  subscriptionPlan             SubscriptionPlan?              @default(BASIC) @map("subscription_plan")
  subscriptionStatus           SubscriptionStatus?            @default(ACTIVE) @map("subscription_status")
  subscriptionEndsAt           DateTime?                      @map("subscription_ends_at")
  settings                     Json?                          @map("settings")
  createdAt                    DateTime                       @default(now()) @map("created_at")
  updatedAt                    DateTime                       @updatedAt @map("updated_at")
  deletedAt                    DateTime?                      @map("deleted_at")
  adGroups                     AdGroup[]
  aiInsights                   AiInsight[]
  aiRecommendations            AiRecommendation[]
  alertHistories               AlertHistory[]
  alertRules                   AlertRule[]
  alerts                       Alert[]
  auditLogs                    AuditLog[]
  businessMetrics              BusinessMetric[]
  campaigns                    Campaign[]
  facebookAdsAccounts          FacebookAdsAccount[]
  googleAdsAccounts            GoogleAdsAccount[]
  googleAnalyticsAccounts      GoogleAnalyticsAccount[]
  integrations                 Integration[]
  lineAdsAccounts              LineAdsAccount[]
  metrics                      Metric[]
  notifications                Notification[]
  platformTokens               PlatformToken[]
  reports                      Report[]
  roles                        Role[]
  seoAnchorText                SeoAnchorText[]
  seoOffpageMetricSnapshots    SeoOffpageMetricSnapshots[]
  SeoSearchIntent              SeoSearchIntent[]
  seoTopKeywords               SeoTopKeywords[]
  seoTrafficByLocation         SeoTrafficByLocation[]
  suppabet                     Suppabet[]
  syncLogs                     SyncLog[]
  securityEvents               SecurityEvent[]
  tiktokAdsAccounts            TikTokAdsAccount[]
  users                        User[]
  userBehaviorEvents           UserBehavior[]
  webAnalyticsDaily            WebAnalyticsDaily[]
  searchConsolePerformance     SearchConsolePerformance[]

  @@map("tenants")
}

/// User - ผู้ใช้งานในระบบ
model User {
  id                      String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId                String         @map("tenant_id") @db.Uuid
  email                   String         @map("email") @db.VarChar(255)
  password                String         @map("password_hash") @db.VarChar(255)
  firstName               String?        @map("first_name") @db.VarChar(100)
  lastName                String?        @map("last_name") @db.VarChar(100)
  phone                   String?        @map("phone") @db.VarChar(20)
  avatarUrl               String?        @map("avatar_url")
  role                    UserRole       @default(CLIENT) @map("role")
  adminType               String?        @map("admin_type") @db.VarChar(50)
  isActive                Boolean        @default(true) @map("is_active")
  
  // Auth & Security
  username                        String?        @unique @map("username") @db.VarChar(30)
  emailVerificationTokenHash      String?        @map("email_verification_token_hash") @db.VarChar(255)
  emailVerificationTokenExpiresAt DateTime?      @map("email_verification_token_expires_at")
  passwordResetTokenHash          String?        @map("password_reset_token_hash") @db.VarChar(255)
  passwordResetTokenExpiresAt     DateTime?      @map("password_reset_token_expires_at")
  termsAcceptedAt                 DateTime?      @map("terms_accepted_at")
  emailVerified           Boolean        @default(false) @map("email_verified")
  twoFactorEnabled        Boolean        @default(false) @map("two_factor_enabled")
  lastLoginAt             DateTime?      @map("last_login_at")
  lastLoginIp             String?        @map("last_login_ip") @db.VarChar(45)
  failedLoginCount        Int            @default(0) @map("failed_login_count")
  lockedUntil             DateTime?      @map("locked_until")
  passwordChangedAt       DateTime?      @map("password_changed_at")
  notificationPreferences Json?          @map("notification_preferences")
  timezone                String?        @default("Asia/Bangkok") @map("timezone") @db.VarChar(50)
  language                String?        @default("th") @map("language") @db.VarChar(5)
  createdAt               DateTime       @default(now()) @map("created_at")
  updatedAt               DateTime       @updatedAt @map("updated_at")
  deletedAt               DateTime?      @map("deleted_at")
  auditLogs               AuditLog[]
  notifications           Notification[]
  reports                 Report[]
  sessions                Session[]
  chatSessions            ChatSession[]
  behaviorEvents          UserBehavior[]
  securityEvents          SecurityEvent[]
  tenant                  Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, email], name: "users_tenant_email_unique")
  @@index([tenantId], map: "idx_users_tenant")
  @@index([email], map: "idx_users_email")
  @@index([role], map: "idx_users_role")
  @@index([isActive], map: "idx_users_is_active")
  @@index([tenantId, isActive], map: "idx_users_tenant_active")
  @@map("users")
}

/// Role - บทบาทและสิทธิ์แบบ Custom
model Role {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  name        String   @map("name") @db.VarChar(100)
  description String?  @map("description")
  permissions Json?    @map("permissions")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, name], name: "roles_tenant_name_unique")
  @@index([tenantId], map: "idx_roles_tenant")
  @@map("roles")
}

/// Session - User Sessions (JWT Refresh Tokens)
model Session {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId       String   @map("user_id") @db.Uuid
  refreshToken String   @unique @map("refresh_token") @db.VarChar(500)
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  expiresAt    DateTime @map("expires_at")
  lastActivity DateTime @default(now()) @map("last_activity_at")
  createdAt    DateTime @default(now()) @map("created_at")
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([refreshToken], map: "idx_sessions_token")
  @@index([expiresAt], map: "idx_sessions_expires")
  @@map("sessions")
}

/// Integration - การเชื่อมต่อ Platform (Unified)
model Integration {
  id                   String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId             String     @map("tenant_id") @db.Uuid
  type                 AdPlatform @map("type")
  name                 String     @map("name") @db.VarChar(255)
  provider             String?    @map("provider") @db.VarChar(50)
  credentials          Json?      @map("credentials")
  config               Json?      @map("config")
  status               String     @default("active") @map("status") @db.VarChar(20)
  isActive             Boolean    @default(true) @map("is_active")
  lastSyncAt           DateTime?  @map("last_sync_at")
  syncFrequencyMinutes Int        @default(15) @map("sync_frequency_minutes")
  createdAt            DateTime   @default(now()) @map("created_at")
  updatedAt            DateTime   @updatedAt @map("updated_at")
  campaigns            Campaign[]
  tenant               Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  syncLogs             SyncLog[]

  @@unique([tenantId, type, name], name: "integrations_tenant_type_name_unique")
  @@index([tenantId], map: "idx_integrations_tenant")
  @@index([type], map: "idx_integrations_type")
  @@index([isActive], map: "idx_integrations_active")
  @@map("integrations")
}

/// Google Ads Account
model GoogleAdsAccount {
  id             String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId       String     @map("tenant_id") @db.Uuid
  customerId     String     @map("customer_id") @db.VarChar(255)
  accountName    String?    @map("account_name") @db.VarChar(255)
  status         String     @default("ENABLED") @map("status") @db.VarChar(20)
  accessToken    String     @map("access_token")
  refreshToken   String     @map("refresh_token")
  tokenExpiresAt DateTime?  @map("token_expires_at")
  lastSyncAt     DateTime?  @map("last_sync_at")
  createdAt      DateTime   @default(now()) @map("created_at")
  updatedAt      DateTime   @updatedAt @map("updated_at")
  campaigns      Campaign[]
  tenant         Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, customerId], name: "google_ads_accounts_tenant_customer_unique")
  @@index([status], map: "idx_google_ads_status")
  @@map("google_ads_accounts")
}

/// Google Analytics Account (GA4)
model GoogleAnalyticsAccount {
  id                String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId          String              @map("tenant_id") @db.Uuid
  propertyId        String              @map("property_id") @db.VarChar(255)
  propertyName      String?             @map("property_name") @db.VarChar(255)
  accessToken       String              @map("access_token")
  refreshToken      String              @map("refresh_token")
  tokenExpiresAt    DateTime?           @map("token_expires_at")
  status            String              @default("ACTIVE") @map("status") @db.VarChar(20)
  lastSyncAt        DateTime?           @map("last_sync_at")
  createdAt         DateTime            @default(now()) @map("created_at")
  updatedAt         DateTime            @updatedAt @map("updated_at")
  tenant            Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  webAnalyticsDaily WebAnalyticsDaily[]

  @@unique([tenantId, propertyId], name: "google_analytics_accounts_tenant_property_unique")
  @@map("google_analytics_accounts")
}

/// Facebook Ads Account
model FacebookAdsAccount {
  id             String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId       String     @map("tenant_id") @db.Uuid
  accountId      String     @map("account_id") @db.VarChar(255)
  accountName    String?    @map("account_name") @db.VarChar(255)
  accessToken    String     @map("access_token")
  tokenExpiresAt DateTime?  @map("token_expires_at")
  status         String     @default("ACTIVE") @map("status") @db.VarChar(20)
  lastSyncAt     DateTime?  @map("last_sync_at")
  createdAt      DateTime   @default(now()) @map("created_at")
  updatedAt      DateTime   @updatedAt @map("updated_at")
  campaigns      Campaign[]
  tenant         Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, accountId], name: "facebook_ads_accounts_tenant_account_unique")
  @@index([status], map: "idx_facebook_ads_status")
  @@map("facebook_ads_accounts")
}

/// TikTok Ads Account
model TikTokAdsAccount {
  id             String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId       String     @map("tenant_id") @db.Uuid
  advertiserId   String     @map("advertiser_id") @db.VarChar(255)
  accountName    String?    @map("account_name") @db.VarChar(255)
  accessToken    String     @map("access_token")
  refreshToken   String?    @map("refresh_token")
  tokenExpiresAt DateTime?  @map("token_expires_at")
  status         String     @default("ACTIVE") @map("status") @db.VarChar(20)
  lastSyncAt     DateTime?  @map("last_sync_at")
  createdAt      DateTime   @default(now()) @map("created_at")
  updatedAt      DateTime   @updatedAt @map("updated_at")
  campaigns      Campaign[]
  tenant         Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, advertiserId], name: "tiktok_ads_accounts_tenant_advertiser_unique")
  @@map("tiktok_ads_accounts")
}

/// LINE Ads Account
model LineAdsAccount {
  id             String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId       String     @map("tenant_id") @db.Uuid
  channelId      String     @map("channel_id") @db.VarChar(255)
  channelName    String?    @map("channel_name") @db.VarChar(255)
  accessToken    String     @map("access_token")
  tokenExpiresAt DateTime?  @map("token_expires_at")
  status         String     @default("ACTIVE") @map("status") @db.VarChar(20)
  lastSyncAt     DateTime?  @map("last_sync_at")
  createdAt      DateTime   @default(now()) @map("created_at")
  updatedAt      DateTime   @updatedAt @map("updated_at")
  campaigns      Campaign[]
  tenant         Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, channelId], name: "line_ads_accounts_tenant_channel_unique")
  @@map("line_ads_accounts")
}

/// Platform Token - Unified Token Management
model PlatformToken {
  id              String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId        String     @map("tenant_id") @db.Uuid
  platform        AdPlatform @map("platform")
  accountId       String     @map("account_id") @db.VarChar(255)
  accessToken     String     @map("access_token")
  refreshToken    String?    @map("refresh_token")
  tokenType       String?    @default("Bearer") @map("token_type") @db.VarChar(50)
  tokenScope      String?    @map("token_scope")
  expiresAt       DateTime?  @map("expires_at")
  refreshedAt     DateTime?  @map("refreshed_at")
  lastUsedAt      DateTime?  @map("last_used_at")
  isValid         Boolean    @default(true) @map("is_valid")
  errorMessage    String?    @map("error_message")
  refreshAttempts Int        @default(0) @map("refresh_attempts")
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")
  createdBy       String?    @map("created_by") @db.Uuid
  tenant          Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, platform, accountId], name: "platform_tokens_tenant_platform_account_unique")
  @@index([platform], map: "idx_platform_tokens_platform")
  @@index([isValid], map: "idx_platform_tokens_valid")
  @@map("platform_tokens")
}

/// Campaign - แคมเปญการตลาด
model Campaign {
  id                   String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId             String              @map("tenant_id") @db.Uuid
  integrationId        String?             @map("integration_id") @db.Uuid
  externalId           String?             @map("external_id") @db.VarChar(255)
  name                 String              @map("name") @db.VarChar(255)
  platform             AdPlatform          @map("platform")
  campaignType         String?             @map("campaign_type") @db.VarChar(50)
  objective            String?             @map("objective") @db.VarChar(50)
  status               CampaignStatus      @default(ACTIVE) @map("status")
  budget               Decimal?            @map("budget") @db.Decimal(15, 2)
  budgetType           String?             @map("budget_type") @db.VarChar(20)
  currency             String              @default("THB") @map("currency") @db.VarChar(3)
  startDate            DateTime?           @map("start_date") @db.Date
  endDate              DateTime?           @map("end_date") @db.Date
  lastSyncedAt         DateTime?           @map("last_synced_at")
  syncStatus           SyncStatus?         @default(PENDING) @map("sync_status")
  googleAdsAccountId   String?             @map("google_ads_account_id") @db.Uuid
  facebookAdsAccountId String?             @map("facebook_ads_account_id") @db.Uuid
  tiktokAdsAccountId   String?             @map("tiktok_ads_account_id") @db.Uuid
  lineAdsAccountId     String?             @map("line_ads_account_id") @db.Uuid
  createdAt            DateTime            @default(now()) @map("created_at")
  updatedAt            DateTime            @updatedAt @map("updated_at")
  adGroups             AdGroup[]
  alerts               Alert[]
  facebookAdsAccount   FacebookAdsAccount? @relation(fields: [facebookAdsAccountId], references: [id])
  googleAdsAccount     GoogleAdsAccount?   @relation(fields: [googleAdsAccountId], references: [id])
  integration          Integration?        @relation(fields: [integrationId], references: [id])
  lineAdsAccount       LineAdsAccount?     @relation(fields: [lineAdsAccountId], references: [id])
  tenant               Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tiktokAdsAccount     TikTokAdsAccount?   @relation(fields: [tiktokAdsAccountId], references: [id])
  metrics              Metric[]

  @@unique([tenantId, platform, externalId], name: "campaigns_tenant_platform_external_unique")
  @@index([tenantId], map: "idx_campaigns_tenant")
  @@index([platform], map: "idx_campaigns_platform")
  @@index([status], map: "idx_campaigns_status")
  @@index([tenantId, status], map: "idx_campaigns_tenant_status")
  @@index([tenantId, createdAt], map: "idx_campaigns_tenant_created")
  @@index([googleAdsAccountId], map: "idx_campaigns_google_ads")
  @@map("campaigns")
}

/// AdGroup - กลุ่มโฆษณาภายใต้ Campaign
model AdGroup {
  id         String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId   String        @map("tenant_id") @db.Uuid
  campaignId String        @map("campaign_id") @db.Uuid
  externalId String?       @map("external_id") @db.VarChar(255)
  name       String        @map("name") @db.VarChar(255)
  status     AdGroupStatus @default(ACTIVE) @map("status")
  budget     Decimal?      @map("budget") @db.Decimal(15, 2)
  bidAmount  Decimal?      @map("bid_amount") @db.Decimal(15, 4)
  bidType    String?       @map("bid_type") @db.VarChar(50)
  targeting  Json?         @map("targeting")
  createdAt  DateTime      @default(now()) @map("created_at")
  updatedAt  DateTime      @updatedAt @map("updated_at")
  campaign   Campaign      @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  tenant     Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, campaignId, externalId], name: "ad_groups_tenant_campaign_external_unique")
  @@index([tenantId], map: "idx_ad_groups_tenant")
  @@index([campaignId], map: "idx_ad_groups_campaign")
  @@index([status], map: "idx_ad_groups_status")
  @@index([tenantId, campaignId], map: "idx_ad_groups_tenant_campaign")
  @@map("ad_groups")
}

/// Metric - Time-series Performance Data
model Metric {
  id                  String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId            String     @map("tenant_id") @db.Uuid
  campaignId          String     @map("campaign_id") @db.Uuid
  date                DateTime   @map("date") @db.Date
  hour                Int?       @map("hour")
  platform            AdPlatform @map("platform")
  source              String?    @map("source") @db.VarChar(100)
  impressions         Int        @default(0) @map("impressions")
  clicks              Int        @default(0) @map("clicks")
  conversions         Int        @default(0) @map("conversions")
  spend               Decimal    @default(0) @map("spend") @db.Decimal(15, 2)
  costPerClick        Decimal    @default(0) @map("cost_per_click") @db.Decimal(10, 4)
  costPerMille        Decimal    @default(0) @map("cost_per_mille") @db.Decimal(10, 4)
  costPerAction       Decimal    @default(0) @map("cost_per_action") @db.Decimal(10, 4)
  ctr                 Decimal    @default(0) @map("ctr") @db.Decimal(8, 4)
  conversionRate      Decimal    @default(0) @map("conversion_rate") @db.Decimal(8, 4)
  roas                Decimal    @default(0) @map("roas") @db.Decimal(10, 4)
  revenue             Decimal    @default(0) @map("revenue") @db.Decimal(15, 2)
  orders              Int        @default(0) @map("orders")
  averageOrderValue   Decimal    @default(0) @map("average_order_value") @db.Decimal(10, 2)
  cartAbandonmentRate Decimal    @default(0) @map("cart_abandonment_rate") @db.Decimal(8, 4)
  organicTraffic      Int        @default(0) @map("organic_traffic")
  bounceRate          Decimal    @default(0) @map("bounce_rate") @db.Decimal(8, 4)
  avgSessionDuration  Int        @default(0) @map("avg_session_duration")
  metadata            Json?      @map("metadata")
  isMockData          Boolean    @default(false) @map("is_mock_data")
  createdAt           DateTime   @default(now()) @map("created_at")
  updatedAt           DateTime   @updatedAt @map("updated_at")
  campaign            Campaign   @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  tenant              Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, campaignId, date, hour, platform, source], name: "metrics_unique_key")
  @@index([tenantId, date(sort: Desc)], map: "idx_metrics_tenant_date")
  @@index([campaignId, date(sort: Desc)], map: "idx_metrics_campaign_date")
  @@index([platform], map: "idx_metrics_platform")
  @@index([date(sort: Desc)], map: "idx_metrics_date")
  @@map("metrics")
}

/// Web Analytics Daily - GA4 Daily Aggregates
model WebAnalyticsDaily {
  id                 String                  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId           String                  @map("tenant_id") @db.Uuid
  propertyId         String                  @map("property_id") @db.VarChar(255)
  gaAccountId        String?                 @map("ga_account_id") @db.Uuid
  date               DateTime                @map("date") @db.Date
  activeUsers        Int                     @default(0) @map("active_users")
  newUsers           Int                     @default(0) @map("new_users")
  sessions           Int                     @default(0) @map("sessions")
  screenPageViews    Int                     @default(0) @map("screen_page_views")
  engagementRate     Decimal                 @default(0) @map("engagement_rate") @db.Decimal(8, 4)
  bounceRate         Decimal                 @default(0) @map("bounce_rate") @db.Decimal(8, 4)
  avgSessionDuration Decimal                 @default(0) @map("avg_session_duration") @db.Decimal(10, 2)
  isMockData         Boolean                 @default(false) @map("is_mock_data")
  metadata           Json?                   @map("metadata")
  createdAt          DateTime                @default(now()) @map("created_at")
  updatedAt          DateTime                @updatedAt @map("updated_at")
  gaAccount          GoogleAnalyticsAccount? @relation(fields: [gaAccountId], references: [id])
  tenant             Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, propertyId, date], name: "web_analytics_daily_unique")
  @@index([tenantId], map: "idx_web_analytics_tenant")
  @@index([date], map: "idx_web_analytics_date")
  @@index([propertyId], map: "idx_web_analytics_property")
  @@map("web_analytics_daily")
}

/// SEO Search Intent - Keyword intent analysis (Branded/Non-branded, Intent types)
model SeoSearchIntent {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  date      DateTime @map("date") @db.Date
  type      String   @map("type") @db.VarChar(50)
  keywords  Int      @default(0) @map("keywords")
  traffic   Int      @default(0) @map("traffic")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, date, type], name: "seo_search_intent_unique")
  @@index([tenantId], map: "idx_seo_intent_tenant")
  @@index([date], map: "idx_seo_intent_date")
  @@map("seo_search_intent")
}

/// AI Insight - AI/N8N generated insight payloads (JSONB)
model AiInsight {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId   String   @map("tenant_id") @db.Uuid
  type       String   @map("type") @db.VarChar(50)
  source     String   @default("n8n") @map("source") @db.VarChar(50)
  title      String?  @map("title") @db.VarChar(255)
  message    String?  @map("message")
  payload    Json?    @map("payload")
  status     String   @default("ACTIVE") @map("status") @db.VarChar(20)
  occurredAt DateTime @default(now()) @map("occurred_at")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId], map: "idx_ai_insights_tenant")
  @@index([tenantId, type, createdAt(sort: Desc)], map: "idx_ai_insights_tenant_type_created")
  @@map("ai_insights")
}

/// UserBehavior - user interaction tracking for AI/analytics
model UserBehavior {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  action    String   @map("action") @db.VarChar(100)
  data      Json?    @map("data") @db.JsonB
  timestamp DateTime @default(now()) @map("timestamp")
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId], map: "idx_user_behavior_tenant")
  @@index([userId], map: "idx_user_behavior_user")
  @@index([action], map: "idx_user_behavior_action")
  @@index([timestamp(sort: Desc)], map: "idx_user_behavior_timestamp")
  @@map("user_behavior")
}

/// BusinessMetric - business performance tracking for AI/analytics
model BusinessMetric {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  metrics   Json     @map("metrics") @db.JsonB
  timestamp DateTime @default(now()) @map("timestamp")
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId], map: "idx_business_metrics_tenant")
  @@index([timestamp(sort: Desc)], map: "idx_business_metrics_timestamp")
  @@map("business_metrics")
}

/// AiRecommendation - actionable AI recommendations
model AiRecommendation {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId    String    @map("tenant_id") @db.Uuid
  type        String    @map("type") @db.VarChar(50)
  title       String    @map("title") @db.VarChar(255)
  description String    @map("description") @db.Text
  priority    String    @default("MEDIUM") @map("priority") @db.VarChar(20)
  confidence  Decimal   @default(0) @map("confidence") @db.Decimal(3, 2)
  status      String    @default("PENDING") @map("status") @db.VarChar(20)
  payload     Json?     @map("payload") @db.JsonB
  executedAt  DateTime? @map("executed_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId], map: "idx_ai_recommendations_tenant")
  @@index([tenantId, status, priority], map: "idx_ai_recommendations_status_priority")
  @@index([createdAt(sort: Desc)], map: "idx_ai_recommendations_created")
  @@map("ai_recommendations")
}

/// SecurityEvent - security & compliance tracking for AI/analytics
model SecurityEvent {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  userId    String?  @map("user_id") @db.Uuid
  eventType String   @map("event_type") @db.VarChar(50)
  severity  String   @default("LOW") @map("severity") @db.VarChar(20)
  message   String   @map("message") @db.Text
  metadata  Json?    @map("metadata") @db.JsonB
  timestamp DateTime @default(now()) @map("timestamp")
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([tenantId], map: "idx_security_events_tenant")
  @@index([userId], map: "idx_security_events_user")
  @@index([eventType], map: "idx_security_events_type")
  @@index([severity], map: "idx_security_events_severity")
  @@index([timestamp(sort: Desc)], map: "idx_security_events_timestamp")
  @@map("security_events")
}

/// Alert Rule - Rule configuration for alerts
model AlertRule {
  id                   String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId             String        @map("tenant_id") @db.Uuid
  campaignId           String?       @map("campaign_id") @db.Uuid
  name                 String        @map("name") @db.VarChar(255)
  description          String?       @map("description")
  alertType            AlertRuleType @default(THRESHOLD) @map("alert_type")
  metric               String        @map("metric") @db.VarChar(50)
  operator             String        @map("operator") @db.VarChar(10)
  threshold            Decimal       @map("threshold") @db.Decimal(15, 4)
  severity             AlertSeverity @default(WARNING) @map("severity")
  isActive             Boolean       @default(true) @map("is_active")
  notificationChannels Json?         @map("notification_channels")
  recipients           Json?         @map("recipients")
  lastTriggeredAt      DateTime?     @map("last_triggered_at")
  triggerCount         Int           @default(0) @map("trigger_count")
  createdAt            DateTime      @default(now()) @map("created_at")
  updatedAt            DateTime      @updatedAt @map("updated_at")
  tenant               Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  alerts               Alert[]

  @@index([tenantId], map: "idx_alert_rules_tenant")
  @@index([isActive], map: "idx_alert_rules_active")
  @@map("alert_rules")
}

/// Alert - Active/triggered alerts
model Alert {
  id            String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId      String         @map("tenant_id") @db.Uuid
  ruleId        String?        @map("rule_id") @db.Uuid
  campaignId    String?        @map("campaign_id") @db.Uuid
  type          String         @map("type") @db.VarChar(50)
  severity      AlertSeverity  @map("severity")
  status        AlertStatus    @default(OPEN) @map("status")
  title         String         @map("title") @db.VarChar(255)
  message       String         @map("message")
  metadata      Json?          @map("metadata")
  createdAt     DateTime       @default(now()) @map("created_at")
  resolvedAt    DateTime?      @map("resolved_at")
  histories     AlertHistory[]
  campaign      Campaign?      @relation(fields: [campaignId], references: [id])
  rule          AlertRule?     @relation(fields: [ruleId], references: [id])
  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  notifications Notification[]

  @@index([tenantId], map: "idx_alerts_tenant")
  @@index([status], map: "idx_alerts_status")
  @@index([severity], map: "idx_alerts_severity")
  @@index([createdAt], map: "idx_alerts_created")
  @@index([tenantId, status, createdAt], map: "idx_alerts_tenant_status_created")
  @@map("alerts")
}

/// Alert History - Historical record of triggered alerts
model AlertHistory {
  id                 String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  alertId            String    @map("alert_id") @db.Uuid
  tenantId           String    @map("tenant_id") @db.Uuid
  triggeredAt        DateTime  @default(now()) @map("triggered_at")
  metricValue        Decimal?  @map("metric_value") @db.Decimal(15, 4)
  thresholdValue     Decimal?  @map("threshold_value") @db.Decimal(15, 4)
  message            String?   @map("message")
  metadata           Json?     @map("metadata")
  notificationSent   Boolean   @default(false) @map("notification_sent")
  notificationSentAt DateTime? @map("notification_sent_at")
  alert              Alert     @relation(fields: [alertId], references: [id], onDelete: Cascade)
  tenant             Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([alertId], map: "idx_alert_history_alert")
  @@index([tenantId], map: "idx_alert_history_tenant")
  @@index([triggeredAt], map: "idx_alert_history_triggered")
  @@map("alert_history")
}

/// Notification - In-app & external notifications
model Notification {
  id          String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId    String              @map("tenant_id") @db.Uuid
  userId      String              @map("user_id") @db.Uuid
  type        String              @map("type") @db.VarChar(50)
  title       String              @map("title") @db.VarChar(255)
  message     String              @map("message")
  channel     NotificationChannel @default(IN_APP) @map("channel")
  priority    String              @default("NORMAL") @map("priority") @db.VarChar(20)
  metadata    Json?               @map("metadata")
  isRead      Boolean             @default(false) @map("is_read")
  readAt      DateTime?           @map("read_at")
  isDismissed Boolean             @default(false) @map("is_dismissed")
  alertId     String?             @map("alert_id") @db.Uuid
  campaignId  String?             @map("campaign_id") @db.Uuid
  scheduledAt DateTime?           @map("scheduled_at")
  sentAt      DateTime?           @map("sent_at")
  expiresAt   DateTime?           @map("expires_at")
  createdAt   DateTime            @default(now()) @map("created_at")
  alert       Alert?              @relation(fields: [alertId], references: [id])
  tenant      Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user        User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead], map: "idx_notifications_user_read")
  @@index([tenantId], map: "idx_notifications_tenant")
  @@index([createdAt], map: "idx_notifications_created")
  @@index([type], map: "idx_notifications_type")
  @@index([userId, createdAt], map: "idx_notifications_user_created")
  @@map("notifications")
}

/// Report - Report configuration and history
model Report {
  id                 String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId           String    @map("tenant_id") @db.Uuid
  createdBy          String?   @map("created_by") @db.Uuid
  name               String    @map("name") @db.VarChar(255)
  description        String?   @map("description")
  reportType         String    @map("report_type") @db.VarChar(50)
  dateRangeType      String    @default("last_7_days") @map("date_range_type") @db.VarChar(20)
  startDate          DateTime? @map("start_date") @db.Date
  endDate            DateTime? @map("end_date") @db.Date
  filters            Json?     @map("filters")
  metrics            Json?     @map("metrics")
  isScheduled        Boolean   @default(false) @map("is_scheduled")
  scheduleFrequency  String?   @map("schedule_frequency") @db.VarChar(20)
  scheduleTime       String?   @map("schedule_time") @db.VarChar(8)
  scheduleDayOfWeek  Int?      @map("schedule_day_of_week")
  scheduleDayOfMonth Int?      @map("schedule_day_of_month")
  exportFormat       String?   @map("export_format") @db.VarChar(10)
  fileUrl            String?   @map("file_url")
  fileSize           Int?      @map("file_size")
  generatedAt        DateTime? @map("generated_at")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")
  user               User?     @relation(fields: [createdBy], references: [id])
  tenant             Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId], map: "idx_reports_tenant")
  @@index([createdBy], map: "idx_reports_creator")
  @@map("reports")
}

/// Sync Log - ETL/Sync history
model SyncLog {
  id            String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId      String       @map("tenant_id") @db.Uuid
  integrationId String?      @map("integration_id") @db.Uuid
  platform      AdPlatform   @map("platform")
  accountId     String?      @map("account_id") @db.VarChar(255)
  syncType      SyncType?    @map("sync_type")
  status        SyncStatus   @default(PENDING) @map("status")
  startedAt     DateTime     @default(now()) @map("started_at")
  completedAt   DateTime?    @map("completed_at")
  errorMessage  String?      @map("error_message")
  recordsCount  Int?         @map("records_count")
  recordsSync   Int          @default(0) @map("records_sync")
  data          Json?        @map("data")
  createdAt     DateTime     @default(now()) @map("created_at")
  integration   Integration? @relation(fields: [integrationId], references: [id])
  tenant        Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId], map: "idx_sync_logs_tenant")
  @@index([platform], map: "idx_sync_logs_platform")
  @@index([status], map: "idx_sync_logs_status")
  @@index([createdAt], map: "idx_sync_logs_created")
  @@index([accountId], map: "idx_sync_logs_account")
  @@map("sync_logs")
}

/// Audit Log - Activity tracking
model AuditLog {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId   String?  @map("tenant_id") @db.Uuid
  userId     String?  @map("user_id") @db.Uuid
  action     String   @map("action") @db.VarChar(50)
  entityType String?  @map("entity_type") @db.VarChar(50)
  entityId   String?  @map("entity_id") @db.Uuid
  changes    Json?    @map("changes")
  ipAddress  String?  @map("ip_address") @db.VarChar(45)
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")
  tenant     Tenant?  @relation(fields: [tenantId], references: [id])
  user       User?    @relation(fields: [userId], references: [id])

  @@index([tenantId], map: "idx_audit_logs_tenant")
  @@index([userId], map: "idx_audit_logs_user")
  @@index([action], map: "idx_audit_logs_action")
  @@index([createdAt(sort: Desc)], map: "idx_audit_logs_created")
  @@map("audit_logs")
}

model SeoAnchorText {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId          String   @map("tenant_id") @db.Uuid
  date              DateTime @map("date") @db.Date
  anchorText        String   @map("anchor_text") @db.VarChar(255)
  domains           Int      @map("domains")
  totalBacklinks    Int      @map("total_backlinks")
  dofollowBacklinks Int      @map("dofollow_backlinks")
  referringDomains  Int      @map("referring_domains")
  traffic           Int      @map("traffic")
  trafficPercentage Float    @map("traffic_percentage")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([date], map: "idx_seo_anchor_date")
  @@index([tenantId], map: "idx_seo_anchor_tenant")
  @@map("seo_anchor_text")
}

model SeoOffpageMetricSnapshots {
  id                   String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId             String   @map("tenant_id") @db.Uuid
  date                 DateTime @map("date") @db.Date
  ur                   Float    @map("ur")
  dr                   Float    @map("dr")
  backlinks            Int      @map("backlinks")
  referringDomains     Int      @map("referring_domains")
  keywords             Int      @map("keywords")
  trafficCost          Int      @map("traffic_cost")
  organicTraffic       Int      @map("organic_traffic")
  organicTrafficValue  Int      @map("organic_traffic_value")
  newReferringDomains  Int      @default(0) @map("new_referring_domains")
  newBacklinks         Int      @default(0) @map("new_backlinks")
  lostReferringDomains Int      @default(0) @map("lost_referring_domains")
  lostBacklinks        Int      @default(0) @map("lost_backlinks")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")
  tenant               Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, date])
  @@index([date], map: "idx_seo_offpage_date")
  @@index([tenantId], map: "idx_seo_offpage_tenant")
  @@map("seo_offpage_metric_snapshots")
}

model SeoTopKeywords {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId          String   @map("tenant_id") @db.Uuid
  date              DateTime @map("date") @db.Date
  keyword           String   @map("keyword") @db.VarChar(255)
  position          Float    @map("position")
  volume            Int      @map("volume")
  traffic           Int      @map("traffic")
  trafficPercentage Float    @map("traffic_percentage")
  url               String   @map("url")
  change            Int      @map("change")
  cpc               Float    @default(0) @map("cpc")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([date], map: "idx_seo_keywords_date")
  @@index([tenantId], map: "idx_seo_keywords_tenant")
  @@map("seo_top_keywords")
}

model SeoTrafficByLocation {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId          String   @map("tenant_id") @db.Uuid
  date              DateTime @map("date") @db.Date
  location          String   @map("location") @db.VarChar(100)
  traffic           Int      @map("traffic")
  trafficPercentage Float    @map("traffic_percentage")
  keywords          Int      @map("keywords")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, date, location])
  @@index([date], map: "idx_seo_location_date")
  @@index([tenantId], map: "idx_seo_location_tenant")
  @@map("seo_traffic_by_location")
}

model Suppabet {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  date        DateTime @map("date") @db.Date
  matchName   String   @map("match_name") @db.VarChar(255)
  league      String   @map("league") @db.VarChar(100)
  sportType   String   @map("sport_type") @db.VarChar(50)
  homeOdds    Float    @map("home_odds")
  awayOdds    Float    @map("away_odds")
  drawOdds    Float    @map("draw_odds")
  homeScore   Int      @map("home_score")
  awayScore   Int      @map("away_score")
  result      String   @map("result") @db.VarChar(20)
  totalBets   Int      @map("total_bets")
  totalAmount Float    @map("total_amount")
  payout      Float    @map("payout")
  profit      Float    @map("profit")
  status      String   @default("pending") @map("status") @db.VarChar(20)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([date], map: "idx_suppabet_date")
  @@index([sportType], map: "idx_suppabet_sport")
  @@index([status], map: "idx_suppabet_status")
  @@index([tenantId], map: "idx_suppabet_tenant")
  @@map("suppabet")
}

/// User Roles - กำหนดระดับสิทธิ์การใช้งาน
enum UserRole {
  SUPER_ADMIN @map("super_admin")
  ADMIN       @map("admin")
  MANAGER     @map("manager")
  CLIENT      @map("client")
  VIEWER      @map("viewer")

  @@map("user_role")
}

/// Campaign Status - สถานะของแคมเปญโฆษณา
enum CampaignStatus {
  ACTIVE    @map("active")
  PAUSED    @map("paused")
  DRAFT     @map("draft")
  DELETED   @map("deleted")
  PENDING   @map("pending")
  COMPLETED @map("completed")
  ENDED     @map("ended")

  @@map("campaign_status")
}

/// Ad Platform - แพลตฟอร์มโฆษณาที่รองรับ
enum AdPlatform {
  GOOGLE_ADS       @map("google_ads")
  FACEBOOK         @map("facebook")
  INSTAGRAM        @map("instagram")
  TIKTOK           @map("tiktok")
  LINE_ADS         @map("line_ads")
  GOOGLE_ANALYTICS @map("google_analytics")
  SHOPEE           @map("shopee")
  LAZADA           @map("lazada")

  @@map("ad_platform")
}

model SearchConsolePerformance {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId        String   @map("tenant_id") @db.Uuid
  siteUrl         String   @map("site_url") @db.VarChar(255)
  date            DateTime @map("date") @db.Date
  page            String?  @map("page") @db.Text
  query           String?  @map("query") @db.Text
  device          String?  @map("device") @db.VarChar(50)
  country         String?  @map("country") @db.VarChar(10)
  clicks          Int      @default(0) @map("clicks")
  impressions     Int      @default(0) @map("impressions")
  ctr             Decimal  @default(0) @map("ctr") @db.Decimal(10, 6)
  position        Decimal  @default(0) @map("position") @db.Decimal(10, 4)
  externalKey     String?  @map("external_key") @db.Text
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, date], map: "idx_gsc_tenant_date")
  @@index([siteUrl], map: "idx_gsc_site_url")
  @@index([externalKey], map: "idx_gsc_external_key")
  @@map("search_console_performance")
}

/// Notification Channel - ช่องทางการแจ้งเตือน
enum NotificationChannel {
  IN_APP  @map("in_app")
  EMAIL   @map("email")
  LINE    @map("line")
  SMS     @map("sms")
  WEBHOOK @map("webhook")

  @@map("notification_channel")
}

/// Alert Severity - ระดับความรุนแรงของ Alert
enum AlertSeverity {
  INFO     @map("info")
  WARNING  @map("warning")
  CRITICAL @map("critical")

  @@map("alert_severity")
}

/// Alert Status - สถานะของ Alert
enum AlertStatus {
  OPEN         @map("open")
  ACKNOWLEDGED @map("acknowledged")
  RESOLVED     @map("resolved")

  @@map("alert_status")
}

/// Sync Status - สถานะการ Sync ข้อมูล
enum SyncStatus {
  PENDING     @map("pending")
  STARTED     @map("started")
  IN_PROGRESS @map("in_progress")
  SUCCESS     @map("success")
  COMPLETED   @map("completed")
  FAILED      @map("failed")
  PARTIAL     @map("partial")

  @@map("sync_status")
}

/// Sync Type - ประเภทการ Sync
enum SyncType {
  INITIAL   @map("initial")
  SCHEDULED @map("scheduled")
  MANUAL    @map("manual")

  @@map("sync_type")
}

/// Alert Rule Type - ประเภทกฎแจ้งเตือน
enum AlertRuleType {
  THRESHOLD @map("threshold")
  ANOMALY   @map("anomaly")
  BUDGET    @map("budget")
  PRESET    @map("preset")
  CUSTOM    @map("custom")

  @@map("alert_rule_type")
}

/// Subscription Plan - แพลนการใช้งาน
enum SubscriptionPlan {
  BASIC      @map("basic")
  STANDARD   @map("standard")
  ENTERPRISE @map("enterprise")

  @@map("subscription_plan")
}

/// Subscription Status - สถานะการสมัคร
enum SubscriptionStatus {
  ACTIVE   @map("active")
  INACTIVE @map("inactive")
  TRIAL    @map("trial")
  EXPIRED  @map("expired")

  @@map("subscription_status")
}

/// Ad Group Status - สถานะของ Ad Group
enum AdGroupStatus {
  ACTIVE   @map("active")
  PAUSED   @map("paused")
  DELETED  @map("deleted")
  ARCHIVED @map("archived")

  @@map("ad_group_status")
}

// Chat Persistence Check
model ChatSession {
  id        String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String?       @map("user_id") @db.Uuid // Optional for now
  title     String        @map("title") @db.VarChar(255)
  createdAt DateTime      @default(now()) @map("created_at")
  updatedAt DateTime      @updatedAt @map("updated_at")
  messages  ChatMessage[]
  user      User?         @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId], map: "idx_chat_sessions_user")
  @@map("chat_sessions")
}

model ChatMessage {
  id        String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sessionId String      @map("session_id") @db.Uuid
  role      String      @map("role") @db.VarChar(20) // 'user' | 'assistant'
  content   String      @map("content") @db.Text
  createdAt DateTime    @default(now()) @map("created_at")
  session   ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId], map: "idx_chat_messages_session")
  @@map("chat_messages")
}


